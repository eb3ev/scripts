#!/bin/sh

. "${SCRIPTS_DIR:-${0%/*}/..}/scriptsrc"
. "$lib/var/config"
. "$lib/csv"
. "$lib/lines"

create_setter_script() {
    rm -f "$screenlayout_setter" && mkscript "$screenlayout_setter"
    
    if [ -x "$wallpaper_setter" ]
    then
        echo "sleep 0.5" >> "$screenlayout_setter"
        echo "$1" >> "$screenlayout_setter"
        $screenlayout_setter
    fi
}

get_screenlayouts() {
    monitor_count=$(xrandr | awk '/ connected/' | wc -l)
    layouts=""
    for count in $(seq 1 $monitor_count)
    do
        layouts=$(list_add "$layouts" "$(keys --file="$screenlayouts" --pattern="!/^ *#/ && NF && / ; $count ; / && / ; $(enc --awk-regex "$1") ; / {print \$1}")")
    done

    echo "$layouts"
}


hostname=$(cat /etc/hostname 2>/dev/null)

screenlayout=$(get_screenlayouts "$hostname" | menu -m --prompt="ï¡¸ ")

if [ -n "$screenlayout" ]
then
    key="$screenlayout ; $hostname"

    set_screenlayout_cmd=$(value "$key" --file="$screenlayouts" --index=4)
    set_wallpaper_cmd=$(value "$key" --file="$screenlayouts" --index=5)

    if [ "$1" = "--save" ]
    then
        create_setter_script "$set_screenlayout_cmd"
    fi

    eval "$set_screenlayout_cmd"
    eval "$set_wallpaper_cmd"
fi

