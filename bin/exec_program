#!/bin/sh

. "${SCRIPTS_DIR:-$HOME/scripts}/scriptsrc"
. "$lib/var/config"
. "$lib/var/cache"

IFS=:
if stest -dqr -n "$programs" $PATH
then
    stest -flx $PATH | sort -u > "$programs"
fi
unset IFS

if [ ! -e "$program_history" ]
then
    cp "$programs" "$program_history"
fi

append_program () {
    if [ $(wc -l < "$program_history") -eq 0 ]
    then
        echo "$1" >> "$program_history"
    else
        sed -i "1 i $1" "$program_history"
    fi
}

rm_program () {
    sed -i "/^$(enc 1 "$1")\$/d" "$program_history"
}

rm_dups () {
    dups=$(sort "$scripts_history" | uniq -D)

    while [ -n "$dups" ]
    do
        dup=$(echo "$dups" | head -n 1)

        rm_script "$dup" && append_script "$dup"

        dups=$(sort "$scripts_history" | uniq -D)
    done
}

concat_programs () {
    cat "$programs" "$program_history"
}

sync_program_history () {
    rm_dups

    uniq=$(concat_programs | sort | uniq -u)

    for program in $uniq
    do
        if [ -z "$(grep -x "$program" "$program_history")" ]
        then
            append_program "$program"
        elif [ -z "$(echo "$programs" | grep -x "$program")" ]
        then
            rm_program "$program"
        fi

        if [ $(grep -x "$program" "$program_history" | wc -l) -gt 1 ]
        then
            rm_program "$program" && append_program "$script"
        fi
    done
}

sync_program_history

case "$1" in
    "-s")
        program="$(menu 4 "Launch" < "$program_history")"
        program_prefix="SUDO_ASKPASS=\"$bin/passwd_prompt\" sudo -A"
        ;;
    *)
        program=$(menu 2 "Launch" < "$program_history")
        program_prefix=""
        ;;
esac

if [ -n "$program" ]
then
    rm_program "$program" && append_program "$program"

    eval "$program_prefix \"$program\""
fi

