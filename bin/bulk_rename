#!/bin/sh

. "${SCRIPTS_DIR:-${0%/*}/..}/scriptsrc"
. "$lib/var/config"
. "$lib/lines"
. "$lib/csv"

require_sudo="false"
include_hidden="false"
files=""

for arg in "$@"
do
    case "$arg" in
        "--sudo") require_sudo="true" ;;
        "--include-hidden") include_hidden="true" ;;
        *)
            if [ -e "${arg##*/}" ]
            then
                files=$(list_add "$files" "$arg")
            fi
            ;;
    esac
done

if [ -z "$files" ]
then
    if [ "$include_hidden" = "true" ]
    then
        files=$(ls -A1 2>/dev/null)
    else
        files=$(ls -1 2>/dev/null)
    fi
fi

if [ -z "$files" ]
then
    exit 0
fi

old_files=$(mktemp)
new_files=$(mktemp)

IFS="
"
for file in $files
do
    echo "${file##*/}" >> "$old_files"
    echo "${file##*/}" >> "$new_files"
done
unset IFS

"${EDITOR:-$editor}" "$new_files"

uniq=$(cat "$old_files" "$old_files" "$new_files" | sort | uniq -u)

IFS="
"
for new_file in $uniq
do
    i=$(index_of "$new_file" --file="$new_files")

    if [ $i -ge 1 ] 2>/dev/null
    then
        old_file=$(get_row $i --file="$old_files" 2>/dev/null)

        if [ "$require_sudo" = "true" ]
        then
            sudo mv -n -- "$old_file" "$new_file" 2>/dev/null
        else
            mv -n -- "$old_file" "$new_file" 2>/dev/null
        fi
    fi
done
unset IFS

rm -f -- "$old_files" "$new_files"

