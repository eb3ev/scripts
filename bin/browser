#!/bin/sh

. "${SCRIPTS_DIR:-$HOME/scripts}/scriptsrc"
. "$lib/var/config"
. "$lib/lines"
. "$lib/program"
. "$lib/browser"

run="true"
new_window="false"
new_tab="false"
use_clipboard="false"

args=""
queries=""

for arg in "$@"
do
    case "$arg" in
        "--new-window") new_window="true" ;;
        "--new-tab") new_tab="true" ;;
        "--print-cmd") run="false" ;;
        "--use-clipboard") use_clipboard="true" ;;
        *) queries=$(list_add "$queries" "$arg") ;;
    esac
done

browser=$(cat "$browserrc" 2>/dev/null)

browser_cmd=$(get_cmd "$browser")

if [ "$(installed "$browser_cmd")" = "true" ]
then
    if [ "$new_window" = true ]
    then
        browser_cmd=$(get_new_win_cmd "$browser")
    elif [ "$new_tab" = true ]
    then
        browser_cmd=$(get_new_tab_cmd "$browser")
    fi
else
    browser_cmd="xdg-open"
fi

if [ "$use_clipboard" = true ]
then
    url=$(xclip -selection clipboard -o 2>/dev/null)

    case "$url" in
        http*|www*) queries=$(list_add "$queries" "$url") ;;
    esac
fi

if [ "$run" = "true" ]
then
    if [ -n "$queries" ]
    then
        for query in $queries
        do
            eval "$browser_cmd $query"
        done
    else
        eval "$browser_cmd"
    fi
else
    if [ -n "$queries" ]
    then
        for query in $queries
        do
            echo "$browser_cmd $query"
        done
    else
        echo "$browser_cmd"
    fi
fi

