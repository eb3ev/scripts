#!/bin/sh

. "$SCRIPTS_HOME/scriptsrc"
. "$lib/var/cache"
. "$lib/mount"
. "$lib/lines"

android_identifier="  "
removable_identifier="  "

mounted_devs=""

sync_mounted_devs

while read mounted; do
    dev_name=$(get_column 1 --list="$mounted")

    case $mounted in
        *" ; android ; "*) identifier="$android_identifier" ;;
        *" ; removable ; "*) identifier="$removable_identifier" ;;
    esac

    mounted_devs=$(list_add "$mounted_devs" "$(prepend_to_lines "$identifier" --list="$dev_name")")
done 2>/dev/null < "$mounted_dev_cache"

if [ ! "$mounted_devs" ]; then
    notify-send "Alert" "No unmountable devices"
    exit 0
fi

dev=$(echo "$mounted_devs" | menu -m --prompt="Unmount")

if [ "$dev" ]; then
    case $dev in
        "$android_identifier"*)
            dev="${dev##*$android_identifier}"
            mount_pt=$(value "$dev" --file="$mounted_dev_cache" --index=3)
            unmount_android "$dev"
            ;;
        "$removable_identifier"*)
            dev="${dev##*$removable_identifier}"
            mount_pt=$(value "$dev" --file="$mounted_dev_cache" --index=3)
            unmount_removable "$dev"
            ;;
    esac

    notify-send "Unmounted $dev" "from $mount_pt"

    sleep 0.5
    rm -df "$mount_pts_dir"/* 2>/dev/null
fi

