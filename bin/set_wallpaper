#!/bin/sh

. "$SCRIPTS_HOME/scriptsrc"
. "$lib/var/config"
. "$lib/csv"
. "$lib/lines"

use_presets="false"

pos_opts="\
Zoom
Center
Stretch
Maximize"

get_pos() {
    pos_opt=$(echo "$pos_opts" | menu -m --prompt="漣")

    if [ -n "$pos_opt" ]
    then
        case "$pos_opt" in
            "Zoom") echo "--zoom" ;;
            "Center") echo "--center" ;;
            "Stretch") echo "--stretch" ;;
            "Maximize") echo "--maximize" ;;
        esac
    fi
}

get_wallpaper() {
    wallpaper=$(ls -F1 "$wallpapers_dir" | awk '!/\/$|\*$/' | menu -m --prompt=" ")

    if [ -n "$wallpaper" ]
    then
        pos_arg=$(get_pos)

        if [ -n "$pos_arg" ]
        then
            echo "$pos_arg '$wallpapers_dir/$wallpaper'"
        fi
    fi
}

create_setter_script() {
    rm -f "$wallpaper_setter" && mkscript "$wallpaper_setter"
    
    if [ -x "$wallpaper_setter" ]
    then
        echo "$1" >> "$wallpaper_setter"
        $wallpaper_setter
    fi
}

set_wallpaper() {
    monitors=$(xrandr | awk '/ connected/ {print $1}')

    monitors=$(list_add "$monitors" "Span")

    monitor_arg=""
    pos=""

    args=""
    num_monitors=$(echo "$monitors" | wc -l)
    for _ in $(seq 1 $num_monitors)
    do
        if [ -z "$monitors" ]
        then
            break
        fi

        monitor=$(echo "$monitors" | menu -m --prompt=" ")

        if [ -z "$monitor" ]
        then
            exit 0
        fi

        if [ "$monitor" = "Span" ]
        then
            monitor_arg="--no-randr"
            monitors=""
        else
            monitor_arg="--output $monitor"
            monitors=$(rm_line "Span" --list="$monitors")
            monitors=$(rm_line "$monitor" --list="$monitors")
        fi

        wallpaper_arg=$(get_wallpaper)

        if [ -z "$wallpaper_arg" ]
        then
            exit 0
        fi

        args="$args $monitor_arg $wallpaper_arg"
    done

    echo "xwallpaper$args"
}

get_presets() {
    monitor_count=$(xrandr | awk '/ connected/' | wc -l)

    keys --file="$wallpaper_presets" --pattern="!/^ *#/ && NF && / ; $monitor_count ; / && / ; $(enc --awk-regex "$1") ; / {print \$1}"
}

set_preset_wallpaper() {
    hostname=$(cat /etc/hostname 2>/dev/null)

    presets=$(get_presets "$hostname")

    if [ -z "$presets" ]
    then
        exit 0
    fi
    
    preset=$(echo "$presets" | menu -m --prompt="   Presets")

    if [ -n "$preset" ]
    then
        key="$preset ; $hostname"

        value "$key" --file="$wallpaper_presets" --index=4
    fi
}

for arg in "$@"
do
    case "$arg" in
        "--use-presets") use_presets="true" ;;
    esac
done

if [ "$use_presets" = "true" ]
then
    set_cmd=$(set_preset_wallpaper)
else
    set_cmd=$(set_wallpaper)
fi

if [ -n "$set_cmd" ]
then
    create_setter_script "$set_cmd"
fi

