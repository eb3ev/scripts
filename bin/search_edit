#!/bin/sh

. "${SCRIPTS_DIR:-$HOME/scripts}/scriptsrc"
. "$lib/var/config"
. "$lib/lines"

find_cmd () {
    vals=""
    if [ -n "$1" ]
    then
        if [ -n "$(command -v fd)" ]
        then
            for dir in "$1"
            do
                vals=$(list_add "$vals" "$(fd . "$(printf "$dir")" -H -I -t f)")
            done
        else
            for dir in "$1"
            do
                vals=(list_add "$vals" "$(find "$(printf "$dir")" -type f)")
            done
        fi
    else
        if [ -n "$(command -v fd)" ]
        then
            vals=$(fd . -H -I -t f)
        else
            vals=$(find . -type f)
        fi
    fi

    echo "$vals"
}

get_file () {
    if [ -n "$1" ]
    then
        find_cmd "$1" | menu 1 "Edit"
    else
        find_cmd | menu 1 "Edit"
    fi
}

edit_file () {
    new_window="false"
    require_sudo="false"
    file=""
    for arg in "$@"
    do
        case "$arg" in
            "--new-window") new_window="true" ;;
            "--sudo") require_sudo="true" ;;
            *) file="$arg" ;;
        esac
    done
    if [ "$new_window" = "true" ]
    then
        if [ "$require_sudo" = "true" ]
        then
            term_edit --sudo "$file"
        else
            term_edit "$file"
        fi
    else
        if [ "$require_sudo" = "true" ]
        then
            $sudo_editor "$file"
        else
            $editor "$file"
        fi
    fi
}

args=""
directories=""

for arg in "$@"
do
    case "$arg" in
        "--new-window"|"--sudo")
            args="$args $arg"
            ;;
        *)
            if [ -d "$arg" ]
            then
                directories=$(list_add "$directories" "$arg")
            fi
            ;;
    esac
done

file=$(get_file "$directories")

if [ -n "$file" ]
then
    edit_file $args "$file"
fi

