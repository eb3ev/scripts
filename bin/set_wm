#!/bin/sh

. "$SCRIPTS_HOME/scriptsrc"
. "$lib/lines"
. "$lib/var/config"
. "$lib/program"

set_wm() {
    rm -f "$wmrc" && echo "$1" > "$wmrc"
}

get_curr_wm() {
    curr_wm=$(cat "$wmrc" 2>/dev/null)
    if grep -Fxq "$curr_wm" "$lib/data/wms" && installed "$curr_wm"; then
        echo "$curr_wm"
    fi
}

wms=""
while read wm; do
    if installed "$wm"; then
        wms=$(list_add "$wms" "$wm")
    fi
done 2>/dev/null < "$lib/data/wms"
unset wm

wms=$(rm_line "$(get_curr_wm)" --list="$wms")

if [ "$DISPLAY" ]; then
    wm=$(echo "$wms" | menu -m --prompt="WM")
else
    wm=$(echo "$wms" | override_menu='term' menu -m --prompt="WM")
fi

if [ "$wm" ]; then
    set_wm "$wm"

    if [ "$DISPLAY" ]; then
        kill_all

        if [ "$(pgrep -x "xinit")" ]; then
            pkill "xinit"
        fi
    fi
fi

